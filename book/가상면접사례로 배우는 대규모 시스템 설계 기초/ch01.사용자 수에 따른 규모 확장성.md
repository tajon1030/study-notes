# 가상 면접 사례로 배우는 대규모 시스템 설계 기초

## chapter 1. 사용자 수에 따른 규모 확장성
웹앱, 데이터베이스, 캐시 등이 모두 서버 한 대에서 실행되는 단일서버에서 시작

사용자 요청 처리흐름을 보면 다음과 같다.  
사용자는 웹앱/모바일앱 단말에서 도메인네임을 이용하여 DNS에 질의하여 IP주소를 반환받고, 해당 주소로 HTTP 요청을 전달하면  
웹서버는 HTML페이지나 JSON형태의 응답을 반환한다.  

### 데이터베이스
만약 사용자가 늘어난다면 서버를 늘려야하는데  
늘려야하는 서버중 하나는 웹/모바일 트래픽 처리용도(웹계층)고,   
다른 하나는 DB용 서버(데이터계층)이다.  
이 둘을 분리하면 각각을 독립적으로 확장해 날갈 수 있게 된다.  

#### 어떤 DB를 사용할 것인가? RDB vs NoSQL
- RDB : 관계형 데이터베이스(MySQL, Oracle, PostgreSQL 등)  
자료를 열-컬럼으로 표현  
여러 테이블에 있는 데이터를 관계에 따라 조인하여 합칠 수 있다.  
- NoSQL : 비관계형 데이터베이스(HBase, Cassandra, Neo4j, Amazon DynamoDB 등)  
네가지 분류로 나눌 수 있으며(키-값 저장소/그래프 저장소/컬럼 저장소/문서 저장소)  
조인 연산은 지원하지 않는다.  

#### NoSQL이 바람직한 경우
아주 낮은 지연시간이 요구됨(latency)  
다루는 데이터가 비정형이라 관계형데이터가 아님  
데이터를 직렬화하거나 역직렬화할수있기만 하면 됨  
아주 많은 양의 데이터를 저장할 필요가 있음  

### 수직적 규모 확장Scale Up vs 수평적 규모 확장Scale Out
- Scale Up : 서버에 고사양 자원을 추가  
- Scale Out : 더 많은 서버를 추가  

Scale Up은 단순하다는 장점을 가지며 트래픽양이 적을때에는 좋은 선택이나,  
메모리를 무한대로 증설할 방법이 없고,  
장애에 대한 자동복구(failover) 방안이나 다중화(re-dundancy) 방안을 제시하지 않기때문에  
장애가 발생하면 웹/앱이 완전 중단된다.  

따라서, 대규모 애플리케이션을 지원하는데에는 Scale Out이 적절하다.  

#### 로드밸런서
서버가 여러대일 경우 부하를 고르게 분산하는 역할을 한다.  
사용자는 로드밸런서의 공개IP(public IP)로 접속하면  
로드밸런서는 사설IP(private IP)를 이용하여 서버간 통신을 한다.  
만약 서버1이 다운되면 모든 트래픽은 서버2로 전송하여 웹사이트 전체가 다운되는일을 방지할수있다.  
트래픽이 가파르게 증가하면 다시 웹서버계층에 서버를 추가하여 로드밸런서가 자동으로 트래픽을 분산해줄 것이다.  
이는 곧 자동복구 방안이 되며, 웹계층의 가용성이 향상된다.  

#### DB다중화
보통 서버사이에 master-slave 관계를 설정하고 원본데이터는 master에, 사본은 slave에 저장하는 방식을 이용  
쓰기연산은 master에만 지원(insert/update.delete 등)  
slave는 사본을 전달받아 read만을 지원한다.  

대부분의 어플리케이션은 읽기연산비중이 쓰기보다 훨씬 높다.  
따라서 slave수가 master보다 많다.  

다중화를 이용하면 데이터 변경연산은 주데이터베이스 서버에만 전달되는한편 읽기연산은 부데이터베이스들로 분산되어  
병렬로 처리할 수 있는 query의 수가 늘어나고 **성능**이 좋아진다는 장점이 있다.  
일부 데이터베이스 서버가 파괴되더라도 데이터를 지역적으로 떨어진 여러 장소에 다중화 시켜 계속 서비스를 이어나갈수있게된다.(**안정성**과 **가용성**의 장점)  

##### 데이터베이스 서버 하나가 다운된다면?
- 부서버가 한대뿐인데 다운되는 경우?  
: 읽기연산을 한시적으로 주데이터베이스로 전달하고,  
즉시 새로운 부데이터베이스서버를 생성하여 장애 대체가능  
- 주데이터베이스 서버가 다운되는 경우?  
: 부데이터베이스 서버가 새로운 주 서버가 될것이고 모든 연산이 일시적으로 새로운 주서버상에서 수행  
부서버에 보관된 데이터가 최신상태가 아닐수있기때문에 없는 데이터는 복구스크립트(recovery script)를 돌려서 추가해야한다.  
(다중마스터, 원형 다중화 방식 참고)  

### 응답시간 개선
#### 캐시
비싼연산결과나 자주 참조되는 데이터를 메모리에 두는 저장소  
데이터베이스보다 훨씬빠르기때문에 성능개선은 물론 DB부하를 줄일수있고 캐시계층 규모를 독립적으로 확장하는것도가능하다.  
다양한 캐시전략이 있는데, 캐시할 데이터의 종류,크기, 액세스 패턴에 맞는 방식을 선택하면 된다.  
ex) 읽기주도형 캐시전략: 웹서버와 DB사이에 캐시를 둬서 캐시에 데이터가 있는지 없다면 DB에서 읽어와 캐시에 저장한뒤 데이터를 반환하고,  
있다면 즉시 캐시에서 데이터를 반환  

##### 캐시를 사용할때 유의할점
- 데이터 갱신은 자주일어나지않지만, 참조는 빈번하게 일어나는 경우 고려
- 영속적으로 보관할 데이터를 캐시에 두는 것은 바람직하지 않다.  
(캐시서버는 재시작되면 캐시내 모든 데이터가 사라진다.)  
- 만료에 대한 정책을 마련해두기  
(만료기한이 너무 짧으면 DB를 자주읽게되고 너무 길면 원본과 차이가 날 가능성)  
- 일관성유지에 대해 생각하기  
(원본갱신연산과 캐시갱신연산이 단일트랜잭션으로 처리되지않는 경우 일관성이 깨질 수 있다.)  
- 장애대처방법 생각하기  
(캐시서버가 한대일경우 단일장애지점Single Point of Failure가되어 여러지역에 걸쳐 캐시서버를 분산시켜야한다.)  
- 캐시 메모리를 얼마로 잡을지 생각하기  
(너무작으면 데이터가 자주 밀려나버려evication 성능이 떨어짐. 이를 막을 한가지 방법중 과할당을 하게되면 데이터가 갑자기 늘어났을때 생길 문제도 방지할 수 있다.)  
- 데이터방출정책(evication) 생각하기  
캐시가 다 찼을경우 기존 데이터를 내보내야하는데 LRU, LFU, FIFO 중 경우에 맞게 적용

#### 콘텐츠 전송 네트워크 CDN
정적콘텐츠를 전송하는데 쓰이는 지리적으로 분산된 서버의 네트워크  
이미지, 비디오, CSS, JavaScript 파일 등을 캐시 할 수 있다.  
request path, qeury string, cookie, request header 등의 정보에 기반하여 HTML 페이지를 캐시한다.  
사용자가 웹사이트를 방문했을때 가장 가까운 CDN서버가 정적 콘텐츠를 전달하는 방식  
원본서버가 파일을 CDN서버에 반환할때 TTL(파일이 얼마나 오래 캐시될 수 있는지를 설명)값을 전달하여 만료되지않은 이미지에 대한 요청은 캐시를 통해 처리한다.  

##### CDN 사용시 고려해야할 사항
- 비용 : 데이터 전송양에 따라 요금을 내게되므로 자주사용하지않는 콘텐츠는 CDN에서 빼도록 한다.  
- 적절한 만료시한 설정  
- CDN 장애에 대한 대처방안 : 일시적으로 CDN서버가 응답하지않는다면 문제를 감지하여 원본서버로부터 직접 가져오도록 구성하는것이 필요할 수도있음  
- 콘텐츠 무효화방법 : 아직 만료되지않은 콘텐츠라도 다음가운데 하나를 사용하여 제거  
    - CDN 사업자가 제공하는 API를 이용하여 콘텐츠 무효화  
    - 오브젝트 버저닝 이용하기(xxximage.png?v=2)  

### 무상태 statless 웹 계층
세션데이터와 같은 정보를 웹계층에서 제거한뒤,  
상태정보를 관계형데이터베이스나 NoSql같은 지속성 저장소에 보관하여 필요할 때 가져오도록 구성된 웹 계층  

상태정보를 유지하기위하여 같은 클라이언트로부터의 요청은 항상 같은 서버로 전송하는 방식 ex)LB의 sticky session  
을 사용하면 로드밸런서에 부담을 줄 뿐만 아니라 서버를 추가제거하기도 까다로워진다.  
공유저장소로부터 데이터를 가져온다면 단순하고, 안정적이고, 규모확장이 쉬워진다.  
이 공유저장소는 RDB일수도 Memcached/Redis와 같은 캐시 시스템일 수 도 있으며, NoSQL일 수도 있다.  
NoSQL을 사용한다면 규모확장이 간편하다는 장점을 가진다.  

### 데이터센터
가용성을 높이고 전세계 어디서도 쾌적하게 사용할 수 있도록 해줌  
지리적라우팅GeoDNS : 두개의 데이터 센터를 사용하는 경우 장애가 없는 상황에서 가장 가까운 데이터 센터로 안내되는 절차  

#### 다중데이터센터 아키텍처를 위해 해결해야할 기술적 난제
- 트래픽 우회 : 올바른 데이터 센터로 트래픽을 보내는 효과적 방법 찾기(ex-GeoDNS)  
- 데이터 동기화  
: 데이터 센터마다 별도의 데이터베이스를 사용한다면 장애가 복구되어 트래픽이 다른 데이터베이스로 우회된다더라도 해당 데이터센터에는 찾는 데이터가 없을 수 있다.  
보편적 전략은 데이터를 여러 데이터센터에 걸쳐 다중화하는것이다.  
- 테스트와 배포  
: 여러위치에서 애플리케이션을 테스트해봐야하며,  
자동화된 배포도구는 모든 데이터 센터에 동일한 서비스가 설치되도록 하는데 중요한 역할을 해준다.  

### 메시지큐
메시지큐에 일단 보관된 메시지는 소비자가 꺼낼 때까지 안전히 보관된다는 특성-무손실-을 보장하는 비동기 통신을 지원하는 컴포넌트
producer/publisher라고 불리는 입력서비스가 메시지를 만들어서 메시지큐 publish한다.  
큐에는 consumer/subscriber라고 불리는 서비스/서버가 연결되어있는데, 메시지를 받아 그에 맞는 동작을 수행하는 역할을 한다.  
메시지큐를 이용하면 서비스 또는 서버간 결합이 느슨해젹서, 규모확장성이 보장되어야하는 안정적 애플리케이션을 구성하기 좋다.  
서로의 프로세스가 다운되어있어도 메시지를 발행하고 수신할수있기 때문  

### 로그, 메트릭 그리고 자동화
- 로그 : 에러로그모니터링 -> 시스템의 오류와 문제들을 쉽게 찾아낼수있음  
- 매트릭 : 잘 수집하면 사업현황에 관한 유용한 정보를 얻을 수도 있고, 시스템의 현재 상태를 손쉽게 파악할 수도 있다.  
ex) 호스트단위매트릭:CPU/메모리/디스크IO에 관한 매트릭, 종합aggregated매트릭: DB/캐시성능, 핵심비즈니스매트릭: 일별능동사용자/수익/재방문  
- 자동화 : 자동화도구를 활용하면 개발생산성을 크게 향상시킬수 있다. ex) CI를 도와주는 도구  

### 데이터베이스의 규모 확장
DB규모확장의 두가지 접근법 1. 수직적 2. 수평적

#### 수직적확장ScaleUp
기존서버에 더 많은or 고성능의 자원을 증설  
- 단점 : CPU,RAM을 무한증설할수없다.  
SPOF(Sigle Point of Failure)위험성.  
비용이 많이 든다.

#### 수평적확장
샤딩 : 샤드라고 부르는 작은단위로 DB를 분할하는 기술로, 샤드에 보관되는 데이터 사용에는 중복이 없다.  
ex) 사용자의 데이터를 어느 샤드에 넣을지 사용자 ID에 따라서 user_id % 4 의 함수로 데이터가 보관되는 샤드를 정할수 있음  
##### 샤드 사용시 고려해야할 사항
- 샤딩키를 어떻게 정하느냐 (ex에서는 user_id가 샤딩키)  
- 데이터의 재샤딩시에는 어떻게 할지 (샤드소진이 이루어질때 재배치해야하는데 어떻게 해결할것인지)  
- 유명인사문제(=핫스팟키문제) : 특정 샤드에 query가 집중되어 서버에 과부하가 걸리는 문제  
- 조인과 비정규화 : 여러 샤드에 걸친 데이터는 조인하기가 힘들어진다.  
 
### 정리
시스템 규모 확장을 위해 살펴본 기법들은 다음과 같다.  
- 웹계층은 무상태 계층으로
- 모든 계층에 다중화 도입
- 가능한 많은 데이터를 캐시할 것
- 여러 데이터 센터를 지원할 것
- 정적 콘텐츠는 CDN을 통해 서비스할 것
- 데이터 계층은 샤딩을 통해 규모를 확장할 것
- 각 계층은 독립적 서비스로 분할할 것
- 시스템을 지속적으로 모니터링하고, 자동화 도구들을 활용할 것