# 모던 자바 인 액션

## Part 3. 스트림과 람다를 이용한 효과적 프로그래밍
### chapter 10. 람다를 이용한 도메인 전용 언어
#### 10.1 도메인 전용 언어
DSL : 특정 비즈니스 도메인의 문제를 해결하려고 만든 언어  
자신의 앞에 놓인 문제를 어떻게 해결할지에만 집중할 수 있고,  
특정 도메인의 복잡성을 더 잘 다룰 수 있다.  

DSL 개발시 생각해야할 두가지 필요성  
1. 프로그래머가 아닌 사람도 이해할 수 있어야한다.  
2. 가독성

##### 10.1.1 DSL의 장단점
장점과 비용을 확인하여 DSL을 추가할 것인지 평가  

**장점**  
- 간결함  
- 가독성 : 도메인 영역의 용어를 사용하여 비도메인전문가도 코드를 쉽게 이해 가능(다양한 조직 구성원간 코드와 도메인 영역 공유)  
- 유지보수  
- 높은 수준의 추상화 : 도메인의 문제와 직접적으로 관련되지않은 세부사항을 숨김  
- 집중  
- 관심사 분리  

**단점**  
- 설계의 어려움  
- 개발 비용  
- 추가 우회 계층 : DSL은 추가적 계층으로 도메인 모델을 감싸며 이때 계층을 최대한 작게 만들어 성능 문제를 회피한다.  
- 새로배워야하는 언어  
- 호스팅 언어 한계 : 장황하고 엄격한 문법을 가진 언어로는 사용자 친화적 DSL을 만들기가 어렵다  

##### 10.1.2 JVM에서 이용할 수 있는 다른 DSL 해결책
**내부 DSL**  
기존 호스팅 언어를 기반으로 구현한 DSL(여기서는 자바로 구현한 DSL)  
장점 : 외부DSL에 비해 새로운 패턴과 기술을 배워 구현하는 노력이 현저하게 줄어든다.  
새로운 언어를 배우거나 익숙치않고 복잡한 외부 도구를 배울 필요가 없다.  
순수 자바로 DSL을 구현하면 나머지 코드와 함께 DSL 컴파일 가능(다른 언어의 컴파일러나 외부DSL을 만드는 도구를 사용하지않으므로 추가비용X)  
기존 자바 IDE로 자동완성, 자동 리팩터링 기능을 그대로 사용 가능  
추가로 DSL을 개발해야하는 상황에서 추가 DSL을 쉽게 합칠 수 있다.  

**다중 DSL**  
스칼라나 그루비처럼 자바가 아니지만 JVM에서 실행되며 더 유연하고 표현력이 강력한 언어  
단점: 새로운 프로그래밍 언어를 배우거나 팀의 누군가가 이미 해당 기술을 가지고 있어야 한다.  
두개 이상의 언어가 혼재하므로 여러 컴파일러로 소스를 빌드하도록 빌드 과정을 개선해야한다.  
자바와 호환성이 완벽하지 않을때가 많다. -> 성능 손실  

**외부 DSL**  
호스팅 언어와 독립적으로 자체의 문법을 가짐  
자신만의 문법과 구문으로 새 언어 설계  
필요한 특성을 완벽하게 제공하는 언어를 설계할수있다는 장점  
자바로 개발한 인프라구조 코드와 외부 DSL로 구현한 비즈니스 코드를 명확하게 분리  
호스트언어와 DSL사이에 인공계층이 생긴다는 단점  

#### 10.2 최신 자바 API의 작은 DSL
##### 10.2.1 스트림 API는 컬렉션을 조작하는 DSL
Stream인터페이스는 네이티브 자바 API에 작은 내부 DSL을 적용한 좋은 예이다.  
Stream 인터페이스는 데이터 리스트를 조작하는 DSL로 간주할 수 있다.  
스트림 API의 플루언트 형식은 잘 설계된 DSL의 또 다른 특징이다.

##### 10.2.2 데이터를 수집하는 DSL인 Collectors
Collector인터페이스는 데이터 수집을 수행하는 DSL로 간주할 수 있다.  

#### 10.3 자바로 DSL을 만드는 패턴과 기법
| 패턴 이름                 |  장점 | 단점  |
|--------------------------|---|---|
| 메서드 체인               | 메서드 이름이 키워드 인수 역할을 한다.<br> 선택형 파라미터와 잘 동작한다.<br> DSL사용자가 정해진 순서로 메서드를 호출하도록 강제할 수 있다. <br> 정적 메서드를 최소화 하거나 없앨 수 있다.<br> 문법적 잡음을 최소화 한다. | 구현이 장황하다. <br>  빌드를 연결하는 접착 코드가 필요하다 <br>  들여쓰기 규칙으로만 도메인 객체 계층을 정의한다.  |
| 중첩 함수                 |  구현의 장황함을 줄일 수 있다<br> 함수 중첩으로 도메인 객체 계층을 그대로 반영한다. | 정적메서드의 사용이 빈번하다<br>  이름이 아닌 위치로 인수를 정의한다. <br>  선택형 파라미터를 처리할 메서드 오버로딩이 필요하다.  |
| 람다를 이용한 함수 시퀀싱  |  선택형 파라미터와 잘 동작한다. <br>  정적 메서드를 최소화하거나 없앨 수 있다.<br> 람다 중첩으로 도메인 객체 계층을 반영한다.<br> 빌더의 접착코드가 없다. | 구현이 장황하다.<br> 람다 표현식으로 인한 문법적 잡음이 DSL에 존재한다.  |

#### 10.4 실생활의 자바8 DSL
세가지 유명한 자바 라이브러리에 지금까지 살펴본 패턴이 얼마나 사용되고있는지 알아보기  
##### 10.4.1 jOOQ
SQL을 구현하는 내부적DSL로 자바에 직접 내장된 형식 안전 언어  
메서드 체인 패턴을 jOOQ DSL을 구현하는데 사용한다.  
잘 만들어진 SQL절의 문법을 흉내내려면 메서드체인 패턴의 여러특성(선택적 파라미터를 허용, 미리 정해진 순서로 특정 메서드가 호출될수있게 강제)이 반드시 필요하기 때문  

##### 10.4.2 큐컴버
동작주도개발BDD는 테스트 주도 개발의 확장으로 다양한 비즈니스 시나리오를 구조적으로 서술하는 간단한 도메인 전용 스크립팅 언어를 사용  
큐컴버 : 개발자가 비즈니스 시나리오를 평문 영어로 구현할 수 있도록 도와주는 BDD도구  
테스트 시나리오를 정의하는 스크립트는 제한된 수의 키워드를 제공하며 자유로운 형식으로 문장을 구현할 수 있는 외부 DSL을 활용한다.  
큐컴버의 DSL은 아주 간단하지만 외부적 DSL과 내부적 DSL이 어떻게 효과적으로 합쳐질 수 있으며 람다오 ㅏ함께 가독성있는 함축된 코드를 구현할 수 있는지를 잘 보여준다.  

##### 10.4.3 스프링 통합
스프링 통합은 유명한 엔터프라이즈 통합 패턴을 지원할 수 있도록 의존성 주입에 기반한 스프링 프로그래밍 모델을 확장한다.  
핵심 목표는 복잡한 엔터프라이즈 통합 솔루션을 구현하는 단순한 모델을 제공하고, 비동기, 메시지주도 아키텍처를 쉽게 적용할수있도록 돕는다.  
스프링 기반 애플리케이션 내의 경량의 원격, 메시징, 스케쥴링 기능을 지원  
가장 널리 사용하는 패턴은 메서드 체인(전달되는 메시지 흐름을 만들고 데이터를 변환하는 기능에 적합)  
최상위 수준의 객체를 만들때(그리고 내부의 복잡한 메서드 인수에도)는 함수 시퀀싱과 람다표현식을 사용한다.

#### 10.5 마치며
- DSL의 주요 기능은 개발자와 도메인 전문가 사이의 간격을 좁히는 것이다. 애플리케이션의 비즈니스 로직을 구현하는 코드를 만든 사람이 프로그램이 사용될 비즈니스 필드의 전문 지식을 갖추긴 어렵다. 개발자가 아닌 사람도 이해할 수 있는 언어로 이런 비즈니스 로직을 구현할 수 있다고해서 도메인 전문가가 프로그래머가 되리 수 있는 것은 아니지만 적어도 로직을 읽고 검증하는 역할은 할 수 있다.
- DSL은 크게 내부적DSL(DSL이 사용될 애플리케이션을 개발한 언어를 그대로 활용)과 외부적DSL(직접 언어를 설계해 사용함)로 분류할 수 있다. 내부적 DSL은 개발 노력이 적게 드는 반면 호스팅 언어의 문법 제약을 받는다. 외부적 DSL은 높은 유연성을 제공하지만 구현하기가 어렵다.
- JVM에서 이용할 수 있는 스칼라, 그루비 등의 다른 언어로 다중 DSL을 개발할 수 있다. 이들 언어는 자바보다 유연하며 간결한 편이다. 하지만 이들을 자바와 통합하려면 빌드 과정이 복잡해지며 자바와의 상호 호환성 문제도 생길 수 있다.
- 자바의 장황함과 문법적 엄격함 때문에 보통 자바는 내부적 DSL을 개발하는 언어로는 적합하지 않다. 하지만 자바 8의 람다표현식과 메서드 참조 덕분에 상황이 많이 개선되었다.
- 최신 자바는 자체 API에 작은 DSL을 제공한다. 이들 Stream, Collectors 클래스 등에서 제공하는 작은 DSL은 특히 컬렉션 데이터의 정렬, 필터링, 변화느 그룹화에 유용하다.
- 자바로 DSL을 구현할때 보통 메서드체인, 중첩함수, 함수 시퀀싱 세가지 패턴이 사용된다. 각각의 패턴은 장단점이 있지만 모든 기법을 한 개의 DSL에 합쳐 장점만을 누릴 수 있다.
- 많은 자바 프레임워크와 라이브러리를 DSL을 통해 이용할 수 있다. 10장에서는 SQL 매핑 도구인 jOOQ, BDD 프레임워크 큐컴버, 엔터프라이즈 통합 패턴을 구현한 스프링 확장인 스프링 통합을 살펴봤다.